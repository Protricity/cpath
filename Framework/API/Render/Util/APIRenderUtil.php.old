<?php
/**
 * Project: CleverPath Framework
 * IDE: JetBrains PhpStorm
 * Author: Ari Asulin
 * Email: ari.asulin@gmail.com
 * Date: 4/06/11 */
namespace CPath\Framework\API\Render\Util;

use CPath\Describable\Describable;
use CPath\Describable\IDescribable;
use CPath\Describable\IDescribableAggregate;
use CPath\Framework\API\Exceptions\FieldNotFoundException;
use CPath\Framework\API\Field\Interfaces\IField;
use CPath\Framework\API\Interfaces\IAPI;
use CPath\Framework\API\Util\APIExecuteUtil;
use CPath\Framework\Render\Attribute\IAttributes;
use CPath\Framework\Render\IRender;
use CPath\Framework\Render\Util\RenderMimeSwitchUtility;
use CPath\Framework\Request\Interfaces\IRequest;
use CPath\Framework\Response\Interfaces\IResponse;
use CPath\Framework\Response\Util\ResponseUtil;
use CPath\Framework\Route\Render\IDestination;
use CPath\Handlers\Views\APIView;

class APIRenderUtil implements IAPI, IRender, IDestination, IDescribableAggregate {
    private $mAPI;
    private $mArgs = array();

    function __construct(IAPI $API) {
        $this->mAPI = $API;
    }

    /**
     * Get the Object Description
     * @return IDescribable|String a describable Object, or string describing this object
     */
    function getDescribable() {
        return Describable::get($this->mAPI);
    }

    /**
     * @return IAPI
     */
    public function getAPI() {
        return $this->mAPI;
    }

    /**
     * Execute this API Endpoint with the entire request returning an IResponse object
     * @param IRequest $Request the IRequest instance for this render which contains the request and args
     * @param Array $args
     * @return IResponse the api call response with data, message, and status
     */
    final public function execute(IRequest $Request, $args) {
        $Util = new APIExecuteUtil($this->getAPI());
        return $Util->execute($Request, $args);
    }

    /**
     * Get all API Fields
     * @return IField[]
     */
    function getFields() {
        return $this->mAPI->getFields();
    }

    /**
     * Get an API field by name
     * @param String $fieldName the field name
     * @return IField
     * @throws FieldNotFoundException if the field was not found
     */
    public function getField($fieldName) {
        $Util = new APIExecuteUtil($this->getAPI());
        return $Util->getField($fieldName);
    }


    /**
     * Render this route destination
     * @param IRequest $Request the IRequest instance for this render
     * @param String $path the matched request path for this destination
     * @param Array $args the arguments appended to the path
     * @return String|void always returns void
     */
    function renderDestination(IRequest $Request, $path, $args) {
        $this->mArgs = $args;
        $this->render($Request);
    }

    /**
     * Render this API Call. The output format is based on the requested mimeType from the browser
     * @param IRequest $Request the IRequest instance for this render which contains the request and remaining args
     * @return void
     */
    function render(IRequest $Request) {
//        $Response = $this
//            ->getAPI()
//            ->execute($Request, $this->mArgs);
//        $Util = new ResponseUtil($Response);
        $Util = new RenderMimeSwitchUtility($this);
        $Util->render($Request);
    }


    /**
     * Render request as html and sends headers as necessary
     * @param IRequest $Request the IRequest instance for this render which contains the request and remaining args
     * @param IAttributes $Attr optional attributes for the input field
     * @return void
     */
    function renderHtml(IRequest $Request, IAttributes $Attr=null) {
        $ExecUtil = new APIExecuteUtil($this->getAPI());
        $Response = $ExecUtil->executeOrCatch($Request, $this->mArgs);
        $Render = new APIView($this->getAPI(), $Response);
        $Render->render($Request);
//
//        $Response = $this
//            ->getAPI()
//            ->execute($Request, $this->mArgs);
//        $Util = new ResponseUtil($Response);
//        $Util->renderHtml($Request, $Attr);


//        if(!headers_sent() && !Base::isCLI())
//            header("Content-Type: text/html");
//        $DataResponse = null;
//
//        $Render = new APIView($this, $Route, $DataResponse);
//        //}
//        $Render->render($Request);
    }

//    /**
//     * Sends headers, executes the request, and renders an IResponse as HTML
//     * @param IRequest $Request the IRequest instance for this render which contains the request and remaining args
//     * @return void
//     */
//    public function renderHTML(IRequest $Request) {
//        if(!headers_sent() && !Base::isCLI())
//            header("Content-Type: text/html");
//        $DataResponse = null;
//        //if(strcasecmp($Request->getMethod(), 'get') !== 0) //TODO: did we decide how to handle posts from a browser?
//        //    $DataResponse = $this->execute($Request);
//        //if($Request instanceof RoutableSetWrapper) {
//        //    $RoutableSet = $Request->getRoutableSet();
//         //   $Render = new APIMultiView($RoutableSet, $DataResponse);
//        //} else {
//            $Route = $Request->getRoute();
//            $Render = new APIView($this, $Route, $DataResponse);
//        //}
//        $Render->render($Request);
//        //$DataResponse = $this->execute($Route);
//        //$DataResponse->sendHeaders();
//        //$DataResponse->renderHtml();
//    }
    /**
     * Sends headers, executes the request, and renders an IResponse as JSON
     * @param IRequest $Request the IRequest instance for this render which contains the request and remaining args
     * @return void
     */
    public function renderJSON(IRequest $Request) {
        $ExecUtil = new APIExecuteUtil($this->getAPI());
        $Response = $ExecUtil->executeOrCatch($Request, $this->mArgs);
        $Util = new ResponseUtil($Response);
        $Util->renderJSON($Request);
    }

    /**
     * Sends headers, executes the request, and renders an IResponse as XML
     * @param IRequest $Request the IRequest instance for this render which contains the request and remaining args
     * @param string $rootElementName
     * @return void
     */
    public function renderXML(IRequest $Request, $rootElementName='root') {
        $ExecUtil = new APIExecuteUtil($this->getAPI());
        $Response = $ExecUtil->executeOrCatch($Request, $this->mArgs);
        $Util = new ResponseUtil($Response);
        $Util->renderXML($Request, $rootElementName);
//        if(!headers_sent()) // && !Base::isCLI())
////            header("Content-Type: text/xml");
//        $Response = $this->execute($Request);
//        $Response->sendHeaders();
//        try{
//            $XML = Util::toXML($Response);
//            echo $XML->asXML();
//        } catch (\Exception $ex) {
//            $Response = new ExceptionResponse($ex);
//            $XML = Util::toXML($Response);
//            echo $XML->asXML();
//        }
    }

    /**
     * Sends headers, executes the request, and renders an IResponse as Plain Text
     * @param IRequest $Request the IRequest instance for this render which contains the request and remaining args
     * @return void
     */
    public function renderText(IRequest $Request) {
        $ExecUtil = new APIExecuteUtil($this->getAPI());
        $Response = $ExecUtil->executeOrCatch($Request, $this->mArgs);
        $Util = new ResponseUtil($Response);
        $Util->renderText($Request);
    }

    /**
     * Renders via default method
     * @param IRequest $Request the IRequest instance for this render which contains the request and remaining args
     * @return void
     */
    public function renderDefault(IRequest $Request) {
        $this->renderText($Request);
    }
}