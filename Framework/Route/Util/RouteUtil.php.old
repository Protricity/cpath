<?php
/**
 * Created by PhpStorm.
 * User: ari
 * Date: 3/22/14
 * Time: 4:34 PM
 */
namespace CPath\Framework\Route\Util;

use CPath\Framework\Render\IRender;
use CPath\Framework\Request\Interfaces\IRequest;
use CPath\Framework\Route\Exceptions\RouteNotFoundException;
use CPath\Framework\Route\Map\Common\CallbackRouteMap;
use CPath\Framework\Render\IRenderAggregate;
use CPath\Framework\Route\Routable\IRoutable;

class RouteUtil {
    private $mRoutable;

    public function __construct(IRoutable $Routable) {
        $this->mRoutable = $Routable;
    }

    /**
     * Return an instance of IRender
     * @param IRequest $Request the IRequest instance for this render
     * @param String $path the matched request path for this destination
     * @param String[] $args the arguments appended to the path
     * @throws \InvalidArgumentException
     * @throws \CPath\Framework\Route\Exceptions\RouteNotFoundException
     * @return IRender return the renderer instance
     */
    public function routeRequest(IRequest $Request, $path, $args) {
        $Target = $this->mRoutable;
        $FoundDestination = null;

        $Target->mapRoutes(new CallbackRouteMap($Target, function($prefix, IRenderAggregate $Destination) use ($Request, &$FoundDestination, &$First) {
            if(!$First)
                $First = $Destination;
            list($method, $path) = explode(' ', $prefix, 2);
            if($Request->getMethod() === $method || $method === 'ANY') {
                if(strpos($Request->getPath(), $path) === 0) {
                    $FoundDestination = $Destination;
                    return true;
                }
            }
            return false;
        }));
        if(!$FoundDestination)
            throw new RouteNotFoundException("Route not found: " . $path);

        if($FoundDestination instanceof IRenderAggregate)
            $FoundDestination = $FoundDestination->getRenderer($Request, $path, $args);

        if(!$FoundDestination instanceof IRender)
            throw new \InvalidArgumentException("Class does not implement IRender: " . get_class($Target));

        return $FoundDestination;
    }
}

